# 商店交易系统实现 - 功能清单与注意事项

## 📋 功能清单

### 1. 商店UI系统
- **文件**: `scenes/shop_ui.tscn`, `Scripts/shop_ui.gd`
- **功能**:
  - CanvasLayer布局（layer=128）确保UI始终在游戏场景上方
  - 480×224像素居中Panel，适配480×288分辨率
  - 3列网格布局，最多显示6个商品（2排）
  - 顶部标题 "🛒 商店" + 当前金币显示
  - 右上角ESC关闭按钮（24×24像素）
  - 顶部通知消息显示（淡入淡出动画）
  - ScrollContainer支持商品滚动

### 2. 商品展示系统
- **文件**: `Scripts/shop_ui.gd:73-147`
- **功能**:
  - 动态创建商品卡片（135×140像素）
  - Emoji图标占位符（📦）替代缺失资源
  - 商品名称、价格、描述显示
  - 购买按钮（已拥有商品显示灰色禁用状态）
  - 支持自定义图标路径（如果资源存在）

### 3. 交易系统
- **文件**: `Scripts/autoload/trade_item_list.gd`
- **功能**:
  - 随机商品生成（get_random_items）
  - 购买验证（金币检查、所有权检查）
  - 商品所有权标记（owned状态）
  - 道具效果应用（生命药水、魔法药水、加速、护盾等）
  - 游戏保存集成

### 4. NPC交互系统
- **文件**: `scenes/NPC/shop_keeper.tscn`, `Scripts/shop_keeper.gd`
- **功能**:
  - Area2D proximity检测（26×24矩形范围）
  - "按 E 键打开商店" 交互提示
  - E键打开/关闭商店
  - 鼠标模式切换（显示/隐藏）
  - 多种玩家识别方式（组、名称、类型）

### 5. 玩家控制系统
- **文件**: `Scripts/shop_ui.gd:257-294`
- **功能**:
  - 商店打开时禁用玩家控制（set_process_input + set_physics_process）
  - 商店关闭时恢复玩家控制
  - 双重查找机制（player组 + knight节点名称）

### 6. 项目配置
- **文件**: `project.godot`
- **功能**:
  - ShopUI自动加载（autoload）
  - "interact"输入映射（E键，physical_keycode=69）
  - 窗口分辨率配置（480×288游戏，1440×810显示）

### 7. 测试场景
- **文件**: `Scripts/shop.gd`
- **功能**:
  - 初始测试金币500
  - 金币显示更新
  - ShopKeeper引用设置

---

## ⚠️ 注意事项与错误修复记录

### 1. CanvasLayer属性冲突
**错误**: `Member 'visible' redefined (original in native class 'CanvasLayer')`

**原因**: 尝试重定义CanvasLayer原生属性

**解决方案** (`Scripts/shop_ui.gd:18-25`):
```gdscript
# 使用自定义属性名
var is_shop_visible: bool:
    get:
        return _is_ui_visible()
    set(value):
        if value:
            _open_shop()
        else:
            _close_shop()
```

**注意事项**:
- CanvasLayer有原生`visible`属性，不要重定义
- 使用不同的属性名（如`is_shop_visible`）提供getter/setter
- 通过内部方法`_is_ui_visible()`检查实际可见性

### 2. 方法重写冲突
**错误**: `The method 'show()' overrides a method from native class 'CanvasLayer'`

**原因**: 尝试重写CanvasLayer原生方法

**解决方案** (`Scripts/shop_ui.gd:240-254`):
```gdscript
# 使用自定义方法名
func _open_shop() -> void:
    if ui_control:
        ui_control.visible = true
    _disable_player_control()

func _close_shop() -> void:
    if ui_control:
        ui_control.visible = false
    _enable_player_control()
```

**注意事项**:
- CanvasLayer有原生`show()`和`hide()`方法
- 使用下划线前缀的自定义方法（`_open_shop`, `_close_shop`）
- 通过控制子节点`ui_control.visible`来实现显示/隐藏

### 3. 节点路径错误
**错误**: CloseButton节点路径不匹配

**原因**: 场景结构调整后脚本未更新

**解决方案** (`Scripts/shop_ui.gd:8`):
```gdscript
# 错误路径
@onready var close_button: Button = $ShopUIControl/PanelContainer/VBoxContainer/CloseButton

# 正确路径
@onready var close_button: Button = $ShopUIControl/PanelContainer/CloseButton
```

**注意事项**:
- 场景结构调整后必须更新@onready变量路径
- 关闭按钮从VBoxContainer移到PanelContainer直接子节点
- 使用相对路径从脚本所在节点开始

### 4. UI控件属性无效
**错误**: `Invalid assignment 'horizontal_alignment' on TextureRect`

**原因**: TextureRect不支持horizontal_alignment属性

**解决方案** (`Scripts/shop_ui.gd:88-95`):
```gdscript
# 删除无效属性
icon.custom_minimum_size = Vector2(50, 50)
icon.expand_mode = TextureRect.EXPAND_FIT_WIDTH_PROPORTIONAL
icon.stretch_mode = TextureRect.STRETCH_KEEP_ASPECT_CENTERED
# 不要设置 icon.horizontal_alignment
```

**注意事项**:
- TextureRect没有horizontal_alignment属性
- 使用stretch_mode控制对齐方式
- Button文本默认居中，无需额外设置

### 5. 按钮尺寸异常
**错误**: ESC按钮变成占满右侧的长方形

**原因**: `offset_bottom`与`offset_top`相同，导致高度为0

**解决方案** (`scenes/shop_ui.tscn:112-127`):
```gdscript
[node name="CloseButton" type="Button"]
anchors_preset = 6  # PRESET_TOP_LEFT
anchor_left = 1.0
anchor_top = 0.0
anchor_right = 1.0
anchor_bottom = 0.0  # 关键：必须设置bottom锚点
offset_left = -32.0
offset_top = 8.0
offset_right = -8.0
offset_bottom = 32.0  # 关键：高度 = 32 - 8 = 24px
custom_minimum_size = Vector2(24, 24)
```

**注意事项**:
- 锚点配置：top=0, bottom=0 确保只锚定顶部，不拉伸高度
- offset配置：bottom必须大于top（32 > 8）
- 尺寸计算：宽度 = 32-8=24px，高度 = 32-8=24px
- custom_minimum_size作为保底最小尺寸

### 6. 类型转换警告
**错误**: `Narrowing conversion (float is converted to int and loses precision)`

**原因**: 变量声明为int，但赋值为float

**解决方案** (`Scripts/knight.gd:6`):
```gdscript
# 错误
var direction:int

# 正确
var direction: float
```

**注意事项**:
- `Input.get_axis()`返回float类型（-1.0到1.0）
- 变量类型必须与赋值类型匹配
- Godot 4.x严格类型检查会报warning

### 7. 资源缺失处理
**问题**: 图标资源文件不存在

**解决方案** (`Scripts/shop_ui.gd:87-104`):
```gdscript
if item_data.icon_path != "" and ResourceLoader.exists(item_data.icon_path):
    # 加载真实图标
    icon.texture = load(item_data.icon_path)
else:
    # 使用Emoji占位符
    placeholder.text = "📦"
```

**注意事项**:
- 使用`ResourceLoader.exists()`检查资源是否存在
- 提供fallback方案（Emoji占位符）
- 避免资源加载失败导致崩溃

---

## 📝 开发最佳实践

1. **避免原生冲突**: 继承引擎类时，避免重定义同名属性/方法
2. **类型声明严格**: 变量类型必须与赋值类型匹配
3. **资源安全加载**: 始终检查资源是否存在再加载
4. **路径同步更新**: 场景结构调整后立即更新脚本路径
5. **锚点配置谨慎**: 使用显式锚点和offset确保尺寸正确
6. **双重查找机制**: 使用组和名称两种方式查找玩家节点

---

## 📊 统计信息

**改动文件总计**: 7个文件
- 新增: shop_ui.tscn, shop_ui.gd, shop_keeper.gd
- 修改: project.godot, trade_item_list.gd, shop.gd, knight.gd, shop_keeper.tscn

**代码行数**: 约800行（新增）+ 50行（修改）

**开发日期**: 2025-10-26

---

## 🔗 相关文件

- UI场景: `scenes/shop_ui.tscn`
- UI脚本: `Scripts/shop_ui.gd`
- NPC脚本: `Scripts/shop_keeper.gd`
- 商品列表: `Scripts/autoload/trade_item_list.gd`
- 项目配置: `project.godot`
- 玩家脚本: `Scripts/knight.gd`

---

## ✅ 测试清单

- [x] 商店UI正确显示在屏幕上方
- [x] 3个商品正常显示无需滚动
- [x] ESC按钮显示为24×24小方块
- [x] 购买功能正常工作
- [x] 玩家控制正确禁用/恢复
- [x] 金币扣除和保存正常
- [x] 通知消息正确显示
- [x] NPC交互提示正常
- [x] E键正确打开/关闭商店
- [x] 已拥有商品显示为禁用状态
