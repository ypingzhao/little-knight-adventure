# ğŸ® æŠ€èƒ½æ ‘ç³»ç»Ÿä½¿ç”¨æŒ‡å—

> **ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2025-02-11
> **é€‚ç”¨é¡¹ç›®**: Little Knight Adventure v0.5

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1. ç³»ç»Ÿå·²è‡ªåŠ¨åŠ è½½

`SkillTreeManager` å·²æ³¨å†Œä¸º **autoload å•ä¾‹**ï¼Œå¯ä»¥åœ¨ä»»ä½•è„šæœ¬ä¸­ç›´æ¥è®¿é—®ï¼š

```gdscript
# æ— éœ€é¢„åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨
SkillTreeManager.upgrade_skill("health")
```

### 2. æµ‹è¯•é‡‘å¸ç³»ç»Ÿ

åœ¨æ¸¸æˆå¼€å§‹æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¾ç½®åˆå§‹é‡‘å¸ï¼š

```gdscript
# åœ¨ global_data.gd æˆ–ä»»ä½•è„šæœ¬ä¸­
GlobalData.player_coin = 1000  # è®¾ç½®åˆå§‹é‡‘å¸ä¸º 1000
```

### 3. è°ƒè¯•æŠ€èƒ½æ ‘çŠ¶æ€

åœ¨ä»»ä½•è„šæœ¬ä¸­è°ƒç”¨ï¼š

```gdscript
SkillTreeManager.debug_print_all_skills()
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
========== æŠ€èƒ½æ ‘çŠ¶æ€ ==========
ç”Ÿå‘½å€¼ (health): Lv.0/3 | å·²è§£é”
æ”»å‡»åŠ› (attack): Lv.0/3 | å·²è§£é”
ç§»åŠ¨é€Ÿåº¦ (speed): Lv.0/2 | æœªè§£é”
é‡‘å¸: 1000
================================
```

---

## ğŸ¯ æ·»åŠ æ–°æŠ€èƒ½ï¼ˆ3æ­¥å®Œæˆï¼‰

### æ­¥éª¤ 1ï¼šç¼–è¾‘ `scripts/autoload/skill_tree_manager.gd`

åœ¨ `SKILL_CONFIG` å¸¸é‡ä¸­æ·»åŠ æ–°æŠ€èƒ½ï¼š

```gdscript
const SKILL_CONFIG := {
	# ... ç°æœ‰æŠ€èƒ½ ...

	"critical": {  # ğŸ‘ˆ æŠ€èƒ½IDï¼ˆå”¯ä¸€ï¼‰
		"id": "critical",
		"name": "æš´å‡»ç‡",  # ğŸ‘ˆ æ˜¾ç¤ºåç§°
		"description": "æå‡æš´å‡»å‡ ç‡",
		"max_level": 5,  # ğŸ‘ˆ æœ€å¤§ç­‰çº§

		# ğŸ‘‡ æ¯çº§å‡çº§è´¹ç”¨ï¼ˆæ•°ç»„é•¿åº¦ = max_levelï¼‰
		"cost_per_level": [100, 150, 200, 250, 300],

		# ğŸ‘‡ æ¯çº§æ•°å€¼åŠ æˆï¼ˆæ•°ç»„é•¿åº¦ = max_levelï¼‰
		"value_per_level": [5, 10, 15, 20, 25],  # æš´å‡»ç‡ç™¾åˆ†æ¯”

		"effect_type": "increase_critical_chance",  # ğŸ‘ˆ æ•ˆæœç±»å‹
		"icon_path": "res://assets/ui/icons/critical.png",  # ğŸ‘ˆ å›¾æ ‡è·¯å¾„
		"unlock_condition": "attack",  # ğŸ‘ˆ è§£é”æ¡ä»¶ï¼ˆç•™ç©ºè¡¨ç¤ºé»˜è®¤è§£é”ï¼‰
	},
}
```

### æ­¥éª¤ 2ï¼šå®ç°æŠ€èƒ½æ•ˆæœ

åœ¨ `_apply_skill_effect()` å‡½æ•°ä¸­æ·»åŠ æ–°çš„ caseï¼š

```gdscript
func _apply_skill_effect(skill_id: String, level: int) -> void:
	# ... ç°æœ‰ä»£ç  ...

	match skill_config.effect_type:
		# ... ç°æœ‰ case ...

		"increase_critical_chance":  # ğŸ‘ˆ æ–°å¢æ•ˆæœ
			_increase_critical_chance(effect_value)
		_:
			push_warning("æœªçŸ¥çš„æŠ€èƒ½æ•ˆæœç±»å‹: %s" % skill_config.effect_type)


# ğŸ‘‡ æ–°å¢æ•ˆæœå®ç°å‡½æ•°
func _increase_critical_chance(value: int) -> void:
	# TODO: åœ¨ GlobalData ä¸­æ·»åŠ  player_critical_chance å˜é‡
	# GlobalData.player_critical_chance += value
	print("ğŸ’¥ æš´å‡»ç‡ +%d%%" % value)
```

### æ­¥éª¤ 3ï¼šï¼ˆå¯é€‰ï¼‰åœ¨ GlobalData ä¸­æ·»åŠ å¯¹åº”å˜é‡

å¦‚æœæŠ€èƒ½éœ€è¦å…¨å±€è®¿é—®ï¼Œç¼–è¾‘ `scripts/autoload/global_data.gd`ï¼š

```gdscript
extends Node

var player_fruit: int = 0
var player_coin: int = 0
var player_critical_chance: int = 0  # ğŸ‘ˆ æ–°å¢
```

---

## ğŸ”§ API å‚è€ƒ

### å‡çº§æŠ€èƒ½

```gdscript
# å°è¯•å‡çº§æŠ€èƒ½ï¼ˆä¼šè‡ªåŠ¨æ£€æŸ¥é‡‘å¸ã€ç­‰çº§ä¸Šé™ã€è§£é”æ¡ä»¶ï¼‰
var success = SkillTreeManager.upgrade_skill("health")

if success:
	print("å‡çº§æˆåŠŸï¼")
else:
	print("å‡çº§å¤±è´¥ï¼ˆé‡‘å¸ä¸è¶³æˆ–å·²æ»¡çº§ï¼‰")
```

### æŸ¥è¯¢æŠ€èƒ½ä¿¡æ¯

```gdscript
# è·å–æŠ€èƒ½å½“å‰ç­‰çº§
var level = SkillTreeManager.get_skill_level("health")  # è¿”å›: 0-3

# è·å–æŠ€èƒ½æ˜¯å¦å·²è§£é”
var unlocked = SkillTreeManager.is_skill_unlocked("speed")  # è¿”å›: true/false

# è·å–ä¸‹ä¸€çº§å‡çº§è´¹ç”¨
var cost = SkillTreeManager.get_upgrade_cost("health")  # è¿”å›: 100-300

# è·å–å½“å‰æŠ€èƒ½æ•°å€¼åŠ æˆ
var value = SkillTreeManager.get_skill_value("health")  # è¿”å›: 0-3

# è·å–æŠ€èƒ½å®Œæ•´é…ç½®
var config = SkillTreeManager.get_skill_config("health")
print(config.name)  # "ç”Ÿå‘½å€¼"
print(config.description)  # "æå‡æœ€å¤§ç”Ÿå‘½å€¼"

# è·å–æ‰€æœ‰å·²è§£é”çš„æŠ€èƒ½IDåˆ—è¡¨
var unlocked_skills = SkillTreeManager.get_all_unlocked_skills()
# è¿”å›: ["health", "attack"]
```

### ä¿¡å·ç›‘å¬

```gdscript
func _ready():
	# ç›‘å¬æŠ€èƒ½å‡çº§æˆåŠŸäº‹ä»¶
	SkillTreeManager.skill_upgraded.connect(_on_skill_upgraded)

	# ç›‘å¬å‡çº§å¤±è´¥äº‹ä»¶
	SkillTreeManager.upgrade_failed.connect(_on_upgrade_failed)

func _on_skill_upgraded(skill_id: String, new_level: int):
	print("æŠ€èƒ½ %s å‡çº§åˆ° Lv.%d" % [skill_id, new_level])
	# æ›´æ–° UI æ˜¾ç¤º

func _on_upgrade_failed(skill_id: String, reason: String):
	print("å‡çº§å¤±è´¥: %s" % reason)
	# æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆé‡‘å¸ä¸è¶³ç­‰ï¼‰
```

---

## ğŸ¨ UI é›†æˆç¤ºä¾‹

### åœ¨æŠ€èƒ½æ ‘é¢æ¿ä¸­æ˜¾ç¤ºæŠ€èƒ½åˆ—è¡¨

```gdscript
func _populate_skill_list():
	var vbox = $ScrollContainer/VBoxContainer

	# æ¸…ç©ºç°æœ‰å†…å®¹
	for child in vbox.get_children():
		child.queue_free()

	# éå†æ‰€æœ‰å·²è§£é”çš„æŠ€èƒ½
	for skill_id in SkillTreeManager.get_all_unlocked_skills():
		var config = SkillTreeManager.get_skill_config(skill_id)
		var level = SkillTreeManager.get_skill_level(skill_id)
		var cost = SkillTreeManager.get_upgrade_cost(skill_id)

		# åˆ›å»ºæŠ€èƒ½é¡¹ UI
		var skill_item = _create_skill_item(config, level, cost)
		vbox.add_child(skill_item)

func _create_skill_item(config: Dictionary, level: int, cost: int) -> HBoxContainer:
	var hbox = HBoxContainer.new()

	# æŠ€èƒ½åç§°
	var name_label = Label.new()
	name_label.text = config.name
	hbox.add_child(name_label)

	# å½“å‰ç­‰çº§
	var level_label = Label.new()
	level_label.text = "Lv.%d/%d" % [level, config.max_level]
	hbox.add_child(level_label)

	# å‡çº§æŒ‰é’®
	var upgrade_btn = Button.new()
	if level >= config.max_level:
		upgrade_btn.text = "å·²æ»¡çº§"
		upgrade_btn.disabled = true
	else:
		upgrade_btn.text = "å‡çº§ (%dé‡‘å¸)" % cost
		upgrade_btn.pressed.connect(_on_upgrade_button_pressed.bind(config.id))
	hbox.add_child(upgrade_btn)

	return hbox

func _on_upgrade_button_pressed(skill_id: String):
	SkillTreeManager.upgrade_skill(skill_id)
	# åˆ·æ–° UI
	_populate_skill_list()
```

---

## ğŸ“Š ç°æœ‰æŠ€èƒ½åˆ—è¡¨

| æŠ€èƒ½ID | åç§° | æœ€å¤§ç­‰çº§ | å‡çº§è´¹ç”¨ | æ•ˆæœ | è§£é”æ¡ä»¶ |
|--------|------|---------|---------|------|---------|
| `health` | ç”Ÿå‘½å€¼ | 3 | 100 â†’ 200 â†’ 300 | ç”Ÿå‘½å€¼ +1/+2/+3 | é»˜è®¤è§£é” |
| `attack` | æ”»å‡»åŠ› | 3 | 150 â†’ 250 â†’ 350 | æ”»å‡»åŠ› +1/+2/+3 | é»˜è®¤è§£é” |
| `speed` | ç§»åŠ¨é€Ÿåº¦ | 2 | 200 â†’ 400 | ç§»åŠ¨é€Ÿåº¦ +50/+100 | éœ€è¦å…ˆå‡çº§ health |

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æŠ€èƒ½å‡çº§åæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

**A**: æ£€æŸ¥æŠ€èƒ½çš„ `effect_type` æ˜¯å¦åœ¨ `_apply_skill_effect()` ä¸­å®ç°äº†å¯¹åº”çš„ caseã€‚

### Q2: å¦‚ä½•æ·»åŠ æ›´å¤šæŠ€èƒ½ç­‰çº§ï¼Ÿ

**A**: ä¿®æ”¹ `cost_per_level` å’Œ `value_per_level` æ•°ç»„ï¼ŒåŒæ—¶æ›´æ–° `max_level`ã€‚

```gdscript
"health": {
	"max_level": 5,  # ä» 3 æ”¹ä¸º 5
	"cost_per_level": [100, 200, 300, 500, 800],  # æ·»åŠ æ›´å¤šè´¹ç”¨
	"value_per_level": [1, 2, 3, 5, 8],  # æ·»åŠ æ›´å¤šæ•°å€¼
}
```

### Q3: æŠ€èƒ½ä¾èµ–å…³ç³»ä¸å·¥ä½œï¼Ÿ

**A**: ç¡®ä¿ `unlock_condition` æŒ‡å‘çš„æŠ€èƒ½IDæ˜¯æ­£ç¡®çš„ï¼Œå¹¶ä¸”åœ¨å‡çº§æ—¶ä¼šè§¦å‘ `_check_and_unlock_dependent_skills()`ã€‚

### Q4: å¦‚ä½•é‡ç½®æ‰€æœ‰æŠ€èƒ½ï¼Ÿ

**A**: è°ƒç”¨ `SkillTreeManager.reset_all_skills()`ï¼Œæ‰€æœ‰æŠ€èƒ½ç­‰çº§å°†é‡ç½®ä¸º 0ã€‚

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **æŠ€èƒ½ç®¡ç†å™¨**: [scripts/autoload/skill_tree_manager.gd](../scripts/autoload/skill_tree_manager.gd)
- **å…¨å±€æ•°æ®**: [scripts/autoload/global_data.gd](../scripts/autoload/global_data.gd)
- **ç©å®¶ç”Ÿå‘½å€¼**: [scripts/actors/player/player_health.gd](../scripts/actors/player/player_health.gd)
- **é¡¹ç›®é…ç½®**: [project.godot](../project.godot)

---

## ğŸ“ ä¸‹ä¸€æ­¥ TODO

- [ ] åˆ›å»ºæŠ€èƒ½æ ‘ UI é¢æ¿åœºæ™¯
- [ ] æ·»åŠ æŠ€èƒ½å›¾æ ‡èµ„æº
- [ ] å®ç°æ”»å‡»åŠ›ç³»ç»Ÿé›†æˆ
- [ ] å®ç°ç§»åŠ¨é€Ÿåº¦ç³»ç»Ÿé›†æˆ
- [ ] æ•´åˆåˆ° SaveLoad å­˜æ¡£ç³»ç»Ÿ
- [ ] æ·»åŠ æŠ€èƒ½å‡çº§éŸ³æ•ˆå’ŒåŠ¨ç”»

---

**Happy Coding! ğŸ®**
