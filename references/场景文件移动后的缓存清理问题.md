# 场景文件移动后的缓存清理问题

## 📋 问题描述

在移动场景文件（如 kill_zone.tscn, flying_pig.tscn 等）后，虽然已经更新了所有 .tscn 文件中的引用路径，但在 Godot 编辑器中运行游戏时仍然出现以下错误：

```
E 0:00:02:159 level_manager.gd:28 @ goto_next_room():
Cannot open file 'res://kill_zone.tscn'.
  <C++ 错误> Condition "err != OK" is true. Returning: Ref<Resource>()
  <C++ 源文件> scene/resources/resource_format_text.cpp:1387 @ load()

E 0:00:02:178 level_manager.gd:28 @ goto_next_room():
res://scenes/coco_adventure.tscn:76 - Parse Error:
[ext_resource] referenced non-existent resource at: res://kill_zone.tscn.
```

## 🔍 问题原因

**Godot 编辑器缓存问题**

当场景文件被移动或重命名时，Godot 编辑器会在 `.godot` 文件夹中保留旧的资源路径缓存。即使：

- ✅ 所有 .tscn 文件中的引用已正确更新
- ✅ 所有脚本中的路径已正确更新
- ✅ 文件实际已经移动到新位置

Godot 仍然会尝试从旧路径加载资源，因为缓存中保存了旧的映射关系。

## 🛠️ 解决方案

### 方法 1: 清除 .godot 缓存（推荐）

**步骤**：

1. **关闭 Godot 编辑器**（重要！）

2. **删除 .godot 缓存文件夹**：
   ```bash
   # 在项目根目录执行
   rm -rf .godot
   ```

3. **重新打开项目**：
   - 启动 Godot 编辑器
   - 打开项目
   - Godot 会自动重新扫描所有文件并重建缓存

**说明**：
- `.godot/` 文件夹大小通常在 50-100 MB
- 删除后不影响项目代码和资源
- 重新打开项目时重建缓存可能需要几秒到几十秒

### 方法 2: 在编辑器中手动重新扫描

**步骤**：

1. 在 Godot 编辑器中，点击 **编辑器** → **重新扫描项目文件夹**
2. 等待扫描完成
3. 保存所有打开的场景（Ctrl+Shift+S）
4. 重新运行项目

**注意**：
- 这个方法可能不如方法1彻底
- 如果方法2无效，请使用方法1

## 📊 .godot 缓存文件夹说明

### 文件夹结构

```
.godot/
├── editor/              # 编辑器设置和布局
├── imported/            # 导入的资源缓存
├── shader_cache/        # 着色器编译缓存
├── global_script_class_cache.cfg  # 全局脚本类缓存
├── scene_groups_cache.cfg         # 场景组缓存
└── uid_cache.bin                  # UID 映射缓存
```

### .gitignore 配置

`.godot/` 文件夹应该被 `.gitignore` 忽略：

```gitignore
# Godot 4+ specific ignores
.godot/

# 但可以保留以下缓存（可选）
!.godot/shader_cache/
!.godot/imported/
```

### 何时需要清除缓存

以下情况需要清除 `.godot` 缓存：

1. ✅ **移动或重命名场景文件** (.tscn)
2. ✅ **移动或重命名脚本文件** (.gd)
3. ✅ **更新场景引用的 UID**
4. ✅ **切换分支后场景引用失效**
5. ✅ **资源加载出现莫名错误**
6. ✅ **编辑器显示资源丢失但文件实际存在**

## 🎯 本次问题案例

### 移动的文件

1. `kill_zone.tscn` → `scenes/traps/kill_zone.tscn`
2. `fall_stone.tscn` → `scenes/traps/falling_stone.tscn`
3. `flying_pig.tscn` → `scenes/NPC/flying_pig.tscn`

### 更新的引用

- **kill_zone.tscn**: 6 个场景文件引用
- **flying_pig.tscn**: 1 个场景文件引用
- **falling_stone.tscn**: 1 个场景文件引用

### 验证结果

清除缓存前：
```
❌ Cannot open file 'res://kill_zone.tscn'
❌ Parse Error: referenced non-existent resource
```

清除缓存后：
```
✅ 游戏正常运行，无错误
✅ 场景引用正确加载
✅ 控制台无警告信息
```

## ⚠️ 注意事项

### 清除缓存前

1. **确保所有文件引用已正确更新**
   ```bash
   # 检查是否还有旧路径引用
   grep -r "res://old_path" scenes/
   ```

2. **确保移动的文件实际存在**
   ```bash
   # 检查文件是否存在
   ls -la scenes/new_location/file.tscn
   ```

3. **确保已提交更改到 git**
   ```bash
   git add -A
   git commit -m "移动场景文件并更新引用"
   ```

### 清除缓存后

1. **重新打开项目时耐心等待**
   - Godot 需要重新扫描所有文件
   - 可能需要 10-60 秒

2. **首次运行可能较慢**
   - 着色器需要重新编译
   - 资源需要重新导入

3. **验证所有功能**
   - 测试场景加载
   - 测试关卡切换
   - 检查控制台输出

## 🔧 自动化脚本（可选）

创建一个清理缓存的脚本 `clear_godot_cache.sh`：

```bash
#!/bin/bash
# 清除 Godot 缓存并提示用户重新打开项目

echo "🗑️  正在清除 Godot 缓存..."

# 检查是否在项目根目录
if [ ! -f "project.godot" ]; then
    echo "❌ 错误：请在项目根目录运行此脚本"
    exit 1
fi

# 删除 .godot 缓存
if [ -d ".godot" ]; then
    rm -rf .godot
    echo "✅ .godot 缓存已删除"
else
    echo "⚠️  .godot 文件夹不存在，无需清理"
fi

echo ""
echo "📋 下一步操作："
echo "1. 关闭 Godot 编辑器（如果已打开）"
echo "2. 重新打开项目"
echo "3. 等待 Godot 重建缓存"
echo "4. 运行游戏测试"
```

使用方法：
```bash
chmod +x clear_godot_cache.sh
./clear_godot_cache.sh
```

## 📚 相关文档

- [Godot 项目结构文档](https://docs.godotengine.org/en/stable/tutorials/best_practices/project_organization.html)
- [Godot 资源系统](https://docs.godotengine.org/en/stable/tutorials/assets/index.html)
- [文件组织迁移指南](./文件组织迁移指南.md)
- [UID 不匹配问题修复指南](./UID不匹配问题修复指南.md)

## 💡 最佳实践

### 避免缓存问题的建议

1. **使用 git 移动文件**
   ```bash
   # ✅ 推荐
   git mv old/file.tscn new/file.tscn

   # ❌ 避免
   mv old/file.tscn new/file.tscn
   ```

2. **移动文件后立即测试**
   - 移动文件后立即运行游戏
   - 如果出现加载错误，立即清除缓存

3. **批量移动前先提交**
   ```bash
   git add .
   git commit -m "移动文件前的备份"
   ```

4. **定期清理缓存**
   - 每周或每次重大重构后清除缓存
   - 避免"幽灵"引用问题

---

**文档版本**: 1.0
**最后更新**: 2025-02-11
**适用项目**: Little Knight Adventure v0.5
**问题类型**: Godot 编辑器缓存问题
